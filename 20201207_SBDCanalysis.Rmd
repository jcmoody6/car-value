---
title: "Car Valuation Survey - Sample Statistics and Single Binary Discrete Choice Analysis"
author: "Marisa Papagelis and Joanna Moody"
date: 'Last updated: December 7, 2020'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up
## Initialize packages
```{r packages, warning = FALSE, message=FALSE}
#visualization packages
library(ggplot2)
library(viridis)
library(grid)
library(gridExtra)

#data manipulation packages
library(dplyr)
library(car) #recode function
library(reshape2) #melt function
library(tidyverse)
library(stringr) #part of tidyverse

#modeling packages
#pglm package to include panel effects into the binary logistic regressions for the SBDC questions
#  https://cran.r-project.org/web/packages/pglm/pglm.pdf
library(pglm)
```

## Load data
```{r data, warning = FALSE}
#Read-in Qualtrics survey responses
data_raw <- read.csv("./Qualtrics_FinalSample/Car+Ownership+Valuation+Survey+-+Revised_July+3%2C+2020_10.45.csv", stringsAsFactors=FALSE,na.strings=c("","NA"))
data_gc <- filter(data_raw, gc==1)

#Remove additional "header" rows from Qualtrics data export
data_gc <- data_gc[3:nrow(data_gc),] 
data_gc$ResponseId_orig <- data_gc$ResponseId
data_gc$ResponseId <- as.factor(1:nrow(data_gc))

```

#Built Enviro data
```{r builtenviro, warning = FALSE}
#Load in urban/suburban/rural data 
RuralUrbanSuburban <- read.csv("./Qualtrics_FinalSample/RuralUrbanSuburban_raw.csv", stringsAsFactors = FALSE, na.strings=c("","NA"))

#Creat dummy variables
RuralUrbanSuburban <- RuralUrbanSuburban %>% mutate(Urban = ifelse(Urban...Suburban...Rural=="U", 1, 0),
                                                    Suburban = ifelse(Urban...Suburban...Rural=="S", 1, 0),
                                                    Rural = ifelse(Urban...Suburban...Rural=="R", 1, 0))
#merge data
data_gc<- merge(data_gc, RuralUrbanSuburban, by.x=c('HomeZIP'),
      by.y=c('Zip'),
      all.x=TRUE)

#how many of our observations are missing this information? -- only 2
#length(which(is.na(data_gc$"Urban...Suburban...Rural"))) 
```


# Sample Sociodemographics
```{r sociodem, warning=FALSE}
#Recode HHInc categories to quasi-continuous, numeric variable representing HH income in $1000
data_gc$HHInc <- recode(data_gc$HHInc, 
      "'Less than $10,000'=5; '$10,000 - $14,999'=12.5; '$15,000 - $24,999'=20;
       '$25,000 - $34,999'=30; '$35,000 - $49,999'=42.5; '$50,000 - $74,999'=62.5; 
       '$75,000 - $99,999'=87.5; '$100,000 - $149,999'=125; '$150,000 - $199,999'=175; 
       '$200,000 or more'=225")


#How many cars does your household own?: {"Zero", "1 car", "2 cars", "3 or more cars"}
data_gc$HHCars <- recode(data_gc$HHCars, "'Zero'=0; '1 car'=1; '2 cars'=2; '3 or more cars'=3")

#How many people are there in your household? 
data_gc$HHPers <- recode(data_gc$HHPers, "'1'=1; '2'=2; '3'=3; '4'=4; '5'=5; '6'=6; '7 or more'=7")

#how many working adults are there in your household?
data_gc$HHWkAdult <- recode(data_gc$HHWkAdult, "'0'=0; '1'=1; '2'=2; '3'=3; '4'=4; '5 or more'=5")

#recode RHUse_Typical 
data_gc$RHUse_Typical <- recode(data_gc$RHUse_Typical, "'Zero times' = 0; '1-3 times' = 2; '4-10 times' = 7; 'More than 10 times' = 10")

data_gc <- data_gc %>% mutate(ModeTravel_Typical_1 = as.numeric(ModeTravel_Typical_1),
                              ModeTravel_Typical_2 = as.numeric(ModeTravel_Typical_2),
                              ModeTravel_Typical_3 = as.numeric(ModeTravel_Typical_3),
                              ModeTravel_Typical_4 = as.numeric(ModeTravel_Typical_4),
                              ModeTravel_Typical_6 = as.numeric(ModeTravel_Typical_6),
                              ModeTravel_Typical_7 = as.numeric(ModeTravel_Typical_7),
                              ModeTravel_Typical_8 = as.numeric(ModeTravel_Typical_8),
                              ModeTravel_Typical_9 = as.numeric(ModeTravel_Typical_9),
                              ModeTravel_Typical_10 = as.numeric(ModeTravel_Typical_10),
                              ModeTravel_Typical_car = ModeTravel_Typical_1 + ModeTravel_Typical_2,
                              ModeTravel_Typical_PT = ModeTravel_Typical_3 + ModeTravel_Typical_4,
                              ModeTravel_Typical_RH = ModeTravel_Typical_6 + ModeTravel_Typical_7,
                              ModeTravel_Typical_NMT = ModeTravel_Typical_8 + ModeTravel_Typical_9 + ModeTravel_Typical_10,
                              ModeTravel_Typical_car = ifelse(is.na(ModeTravel_Typical_car)==TRUE, 0, ModeTravel_Typical_car),
                              ModeTravel_Typical_PT = ifelse(is.na(ModeTravel_Typical_PT)==TRUE, 0, ModeTravel_Typical_PT),
                              ModeTravel_Typical_RH = ifelse(is.na(ModeTravel_Typical_RH)==TRUE, 0, ModeTravel_Typical_RH),
                              ModeTravel_Typical_NMT = ifelse(is.na(ModeTravel_Typical_NMT)==TRUE, 0, ModeTravel_Typical_NMT))
                                

#recode Travel during COVID
data_gc <- data_gc %>% mutate(ModeTravel_CV_1 = as.numeric(Q283_1), #personal car as driver
                              ModeTravel_CV_2 = as.numeric(Q283_2), #personal car as passenger
                              ModeTravel_CV_3 = as.numeric(Q283_3), #bus
                              ModeTravel_CV_4 = as.numeric(Q283_4), #train
                              ModeTravel_CV_6 = as.numeric(Q283_6), #ride-hailing - private ride (e.g. UberX, Lyft, Taxi)
                              ModeTravel_CV_7 = as.numeric(Q283_7), #ride-hailing - pooled ride (e.g. UberPool, Shared Lyft)  
                              ModeTravel_CV_8 = as.numeric(Q283_8), #shared bike/scooter
                              ModeTravel_CV_9 = as.numeric(Q283_9), #personal bike
                              ModeTravel_CV_10 = as.numeric(Q283_10), #walk
                              ModeTravel_CV_car = ModeTravel_CV_1 + ModeTravel_CV_2,
                              ModeTravel_CV_PT = ModeTravel_CV_3 + ModeTravel_CV_4,
                              ModeTravel_CV_RH = ModeTravel_CV_6 + ModeTravel_CV_7, 
                              ModeTravel_CV_NMT = ModeTravel_CV_8 + ModeTravel_CV_9, ModeTravel_CV_10)

#clean Unable variable to create binary indicators - multiple check boxes response
Unable_options <- c("Driving a car", "Public transit, including bus or train","Bicycle or scooter",
                    "Ride-hailing")
Unable_vars <- c("Car", "PT", "Bicycle", "RH")
# create indicator columns for each action
for (i in 1:length(Unable_options)) {
  data_gc[paste("Unable", Unable_vars[i], sep = "")] <- as.integer(str_detect(data_gc$Unable, Unable_options[i]))
}
# replace NAs with zero
data_gc <- data_gc %>% mutate(UnableCar = ifelse(is.na(UnableCar)==TRUE, 0, UnableCar),
                              UnablePT = ifelse(is.na(UnablePT)==TRUE, 0, UnablePT),
                              UnableBicycle = ifelse(is.na(UnableBicycle)==TRUE, 0, UnableBicycle),
                              UnableRH = ifelse(is.na(UnableRH)==TRUE, 0, UnableRH))
#checked pairwise correlations among the Unable variables; 
#  low potential for multicollinearity given highest correlation is 0.67
#650 people unable to use car, 328 unable to use PT, 500 unable to use bike/scooter, and 345 unable to use ridehailing


#clean EmpBen (Employee Benefits) variable to create binary indicators - multiple check boxes response
EmpBen_options <- c("Subsidized or free parking", "Discounted or free transit pass",
                    "Shower, indoor bike parking, or other bike commuting amenities",
                    "Carpooling or other program to encourage taking non-single-occupancy vehicles to work")
EmpBen_vars <- c("Parking", "Transit", "Bike", "Carpool")
# create indicator columns for each action
for (i in 1:length(EmpBen_options)) {
  data_gc[paste("EmpBen", EmpBen_vars[i], sep = "")] <- as.integer(str_detect(data_gc$EmpBen, EmpBen_options[i]))
}
# replace NAs with zero
data_gc <- data_gc %>% mutate(EmpBenParking = ifelse(is.na(EmpBenParking)==TRUE, 0, EmpBenParking),
                              EmpBenTransit = ifelse(is.na(EmpBenTransit)==TRUE, 0, EmpBenTransit),
                              EmpBenBike = ifelse(is.na(EmpBenBike)==TRUE, 0, EmpBenBike),
                              EmpBenCarpool = ifelse(is.na(EmpBenCarpool)==TRUE, 0, EmpBenCarpool))
#checked pairwise correlations among the EmpBen variables; 
#  low potential for multicollinearity given highest correlation is 0.25
#273 individuals with bike benefits, 499 with transit benefits, 1162 with parking benefits, and 293 with carpool benefits


#Let's create a bunch more binary indicators!
data_gc <- data_gc %>% mutate(Chicago = ifelse(DMA == "Chicago", 1, 0),
                              Seattle = ifelse(DMA == "Seattle", 1, 0),
                              Dallas = ifelse(DMA == "Dallas", 1, 0),
                              WashingtonDC = ifelse(DMA == "WashingtonDC", 1, 0),
                              Age = as.numeric(Age),
                              Age_bin1 = ifelse(Age %in% 18:29, 1, 0),
                              Age_bin2 = ifelse(Age %in% 30:39, 1, 0),
                              Age_bin3 = ifelse(Age %in% 40:49, 1, 0),
                              Age_bin4 = ifelse(Age %in% 50:59, 1, 0),
                              Age_bin5 = ifelse(Age >=60, 1, 0),
                              Age_1 = ifelse(Age %in% 18:34, 1, 0),
                              Age_2 = ifelse(Age %in% 35:54, 1, 0),
                              Age_3 = ifelse(Age >=55, 1, 0),
                              Male = ifelse(Gender == "Male", 1, 0),
                              NoCar = ifelse(HHCars == 0, 1, 0),
                              CarOwner = ifelse(HHCars > 0, 1, 0),
                              OneCar = ifelse(HHCars == 1, 1, 0),
                              TwoCar = ifelse(HHCars == 2, 1, 0),
                              ThreeCar = ifelse(HHCars == 3, 1, 0),
                              MultiCar = ifelse(HHCars>1, 1, 0),
                              HHCars = as.numeric(HHCars),
                              UsedRH = ifelse(RH_UseInd == "Yes", 1, 0),
                              HHInc_bin1 = ifelse(HHInc < 25, 1, 0),
                              HHInc_bin2 = ifelse(HHInc %in% 25:50, 1, 0),
                              HHInc_bin3 = ifelse(HHInc %in% 50:75, 1, 0),
                              HHInc_bin4 = ifelse(HHInc %in% 75:100, 1, 0),
                              HHInc_bin5 = ifelse(HHInc %in% 100:150, 1, 0),
                              HHInc_bin6 = ifelse(HHInc %in% 150:200, 1, 0),
                              HHInc_bin7 = ifelse(HHInc >= 200, 1, 0),
                              #Hispanic = as.numeric(Hispanic),
                              White = ifelse(grepl("White or Caucasian", Race), 1, 0),
                              Black = ifelse(grepl("Black or African American", Race), 1, 0),
                              Asian = ifelse(grepl("Asian", Race), 1, 0),
                              Native = ifelse(grepl("American Indian or Alaska Native", Race) | grepl("Native Hawaiian or other Pacific Islander", Race), 1, 0),
                              OtherRace = ifelse(grepl("Other", Race), 1, 0),
                              HSorless = ifelse(Educ == "High school diploma or equivalent (GED)" | Educ == "Less than high school diploma", 1, 0),
                              LessCol = ifelse(Educ == "2+ year college/Associates Degree" | Educ == "Some college, no degree", 1, 0),
                              ColDeg = ifelse(Educ == "4+ year college/Bachelors Degree", 1, 0),
                              MstDeg = ifelse(Educ == "Masters Degree", 1, 0),
                              ProDeg = ifelse(Educ == "Doctoral or Professional degree (PhD, M.D., J.D., etc.)", 1, 0),
                              AdvDeg = MstDeg + ProDeg,
                              Unemploy = ifelse(grepl("Unemployed", Employ), 1, 0),
                              Furlough = ifelse(grepl("Furloughed", Employ), 1, 0),
                              Student = ifelse(Employ == "Student", 1, 0),
                              Retired = ifelse(Employ == "Retired", 1, 0),
                              NotWorking = Unemploy + Furlough + Retired,
                              FullTime = ifelse(Employ == "Employed, full-time", 1, 0),
                              PartTime = ifelse(Employ == "Employed, part-time", 1, 0),
                              OtherEmp = ifelse(grepl("family worker", Employ) | Employ == "Military", 1, 0),
                              License = ifelse(License == "Yes", 1, 0),
                              Car_Livelihood = ifelse(Car_Livelihood == "Yes", 1, 0),
                              #variable is systamatically missing for non-car owners, but recode NAs->0
                              Car_Livelihood = ifelse(is.na(Car_Livelihood)==TRUE, 0, Car_Livelihood),
                              PTnonuser = ifelse(ModeTravel_Typical_PT == 0, 1, 0),
                              PTinfrequent = ifelse(ModeTravel_Typical_PT > 0 & ModeTravel_Typical_PT <= 5, 1, 0),
                              PTfrequent = ifelse(ModeTravel_Typical_PT > 5 & ModeTravel_Typical_PT <= 10, 1, 0),
                              PTsuperuser = ifelse(ModeTravel_Typical_PT > 10, 1, 0),
                              PCnonuser = ifelse(ModeTravel_Typical_car == 0, 1, 0),
                              PCinfrequent = ifelse(ModeTravel_Typical_car > 0 & ModeTravel_Typical_car <= 5, 1, 0),
                              PCfrequent = ifelse(ModeTravel_Typical_car > 5 & ModeTravel_Typical_car <= 15, 1, 10),
                              PCsuperuser = ifelse(ModeTravel_Typical_car > 15, 1, 0),
                              RHUse_Typical_bin1 = ifelse(RHUse_Typical == 0, 1, 0),
                              RHUse_Typical_bin2 = ifelse(RHUse_Typical %in% 1:3, 1, 0),
                              RHUse_Typical_bin3 = ifelse(RHUse_Typical %in% 4:10, 1, 0),
                              RHUse_Typical_bin4 = ifelse(RHUse_Typical >= 10, 1, 0),
                              Hispanic = ifelse(Hispanic == "Yes", 1, 0),
                              HHChild = as.numeric(HHChild),
                              HHWkAdult = as.numeric(HHWkAdult),
                              RHUse_Typical = as.numeric(RHUse_Typical),
                              HHInc = as.numeric(HHInc),
                              EssWk = ifelse(EssentialWorker == "Yes", 1, 0),
                              WFH = ifelse(WFH_option == "Yes", 1, 0)
                  )

sociodem_vars <- c("ResponseId", "DMA", "WashingtonDC", "Chicago", "Seattle", "Dallas", "Age", "Age_bin1", "Age_bin2", "Age_bin3", "Age_bin4", "Age_bin5", "Male", "NoCar", "CarOwner", "OneCar", "TwoCar", "ThreeCar", "MultiCar", "UsedRH", "HHInc", "HHInc_bin1", "HHInc_bin2", "HHInc_bin3", "HHInc_bin4", "HHInc_bin5", "HHInc_bin6", "HHInc_bin7", "White", "Black", "Native", "Asian", "OtherRace", "HSorless", "LessCol", "ColDeg", "MstDeg", "ProDeg", "AdvDeg", "Unemploy", "Furlough", "Student", "Retired", "NotWorking", "FullTime", "PartTime", "OtherEmp", "License", "HHPers", "PTnonuser", "PTinfrequent", "PTfrequent", "PTsuperuser", "PCnonuser", "PCinfrequent", "PCfrequent", "PCsuperuser", "Urban...Suburban...Rural", "Rural", "Urban", "Suburban", "ModeTravel_Typical_PT", "ModeTravel_Typical_car", "ModeTravel_Typical_RH", "ModeTravel_CV_car", "ModeTravel_CV_PT", "ModeTravel_CV_RH", "Car_Livelihood", "RHUse_Typical_bin1", "RHUse_Typical_bin2", "RHUse_Typical_bin3", "RHUse_Typical_bin4", "Hispanic", "UnableBicycle", "UnableCar", "UnablePT", "UnableRH", "EmpBenParking", "EmpBenTransit", "EmpBenBike", "EmpBenCarpool", "HHWkAdult", "HHChild", "RHUse_Typical", "HHCars", "HHInc", "Age_1", "Age_2", "Age_3", "ModeTravel_Typical_NMT", "ModeTravel_CV_NMT", "EssWk", "WFH")

data_sociodem <- subset(data_gc, select=sociodem_vars)

```


# Single Binary Discrete Choice (SBDC) questions
4 scenarios x 2 (pre-COVID and during-COVID) = 8 sets of questions

## Pre-COVID (typical year)
### Data prep
```{r sbdc_precovid_prep, warning = FALSE}
###SBDC1: Access to ride-hailing under typical conditions
SBDC1.vars <- c("SBDC1_1", "SBDC1_2", "SBDC1_3", "SBDC1_4", "SBDC1_5", "SBDC1_6", 
                "SBDC1_7", "SBDC1_8", "SBDC1_9", "SBDC1_10", "SBDC1_11", "SBDC1_12")
data_SBDC1 <- subset(data_gc, select=SBDC1.vars)
data_SBDC1[,] <-  ifelse(data_SBDC1[,] ==
      'Keep access to ride-hailing services and receive no money', 0, 1)
data_SBDC1$ResponseId <- data_gc$ResponseId

data_SBDC1_long <- melt(data_SBDC1, id.vars="ResponseId") #from wide to long format
data_SBDC1_long <- data_SBDC1_long[complete.cases(data_SBDC1_long), ]
data_SBDC1_long$variable <- recode(data_SBDC1_long$variable, 
                             "'SBDC1_1'=25; 'SBDC1_2'=50; 'SBDC1_3'=100; 'SBDC1_4'=250;
                              'SBDC1_5'=500; 'SBDC1_6'=750; 'SBDC1_7'=1000; 'SBDC1_8'=2500; 
                              'SBDC1_9'=5000; 'SBDC1_10'=7500; 'SBDC1_11'=10000; 'SBDC1_12'=12500")
colnames(data_SBDC1_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC1_long$Choice <- as.factor(data_SBDC1_long$Choice) 
data_SBDC1_long$Compensation <- as.numeric(as.character(data_SBDC1_long$Compensation))
data_SBDC1_long$Log_Comp <- log(data_SBDC1_long$Compensation)
#add sociodemographic variables
data_SBDC1_long <- merge(data_SBDC1_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC1_long <- filter(data_SBDC1_long, UsedRH==1)


### SBDC2: Access to private car under typical conditions
SBDC2.vars <- c("SBDC2_0", "SBDC2_1", "SBDC2_2", "SBDC2_3", "SBDC2_4", "SBDC2_5", 
                "SBDC2_6", "SBCD2_7", "SBDC2_8", "SBDC2_9", "SBDC2_10", "SBDC2_11", 
                "SBDC2_12", "SBDC2_13", "SBDC2_14", "SBDC2_15")
#Note there is a typo in the variable name for what should have been "SBDC2_7" (with C and D switched)
data_SBDC2 <- subset(data_gc, select=SBDC2.vars)
data_SBDC2[,] <-  ifelse(data_SBDC2[,] ==
      'Keep access to my primary vehicle and receive no money', 0, 1)
data_SBDC2$ResponseId <- data_gc$ResponseId

data_SBDC2_long <- melt(data_SBDC2, id.vars="ResponseId") #from wide to long format
data_SBDC2_long <- data_SBDC2_long[complete.cases(data_SBDC2_long), ]
data_SBDC2_long$variable <- recode(data_SBDC2_long$variable,
                             "'SBDC2_0'=100; 'SBDC2_1'=500; 'SBDC2_2'=1000; 'SBDC2_3'=2000;
                              'SBDC2_4'=3000;'SBDC2_5'=4000; 'SBDC2_6'=5000; 'SBCD2_7'=7500;
                              'SBDC2_8'=10000; 'SBDC2_9'=15000; 'SBDC2_10'=20000; 'SBDC2_11'=25000;
                              'SBDC2_12'=30000; 'SBDC2_13'=40000; 'SBDC2_14'=50000; 'SBDC2_15'=75000")
colnames(data_SBDC2_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC2_long$Choice <- as.factor(data_SBDC2_long$Choice)
data_SBDC2_long$Compensation <- as.numeric(as.character(data_SBDC2_long$Compensation))
data_SBDC2_long$Log_Comp <- log(data_SBDC2_long$Compensation)
data_SBDC2_long <- merge(data_SBDC2_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC2_long <- filter(data_SBDC2_long, CarOwner==1)


### SBDC3: Access to private car with free ride-hailing
SBDC3.vars <- c("SBDC3_0", "SBDC3_1", "SBDC3_2", "SBDC3_3", "SBDC3_4", "SBDC3_5", 
                 "SBDC3_6", "SBDC3_7", "SBDC3_8", "SBDC3_9", "SBDC3_10", "SBDC3_11", 
                "SBDC3_12", "SBDC3_13", "SBDC3_14", "SBDC3_15")
data_SBDC3 <- subset(data_gc, select=SBDC3.vars)
data_SBDC3[,] <-  ifelse(data_SBDC3[,] ==
      'Keep access to my primary vehicle and receive no free ride-hailing nor money', 0, 1)
data_SBDC3$ResponseId <- data_gc$ResponseId

data_SBDC3_long <- melt(data_SBDC3, id.vars="ResponseId") #from wide to long format
data_SBDC3_long <- data_SBDC3_long[complete.cases(data_SBDC3_long), ]
data_SBDC3_long$variable <- recode(data_SBDC3_long$variable,
                             "'SBDC3_0'=100; 'SBDC3_1'=500; 'SBDC3_2'=1000; 'SBDC3_3'=2000;
                              'SBDC3_4'=3000;'SBDC3_5'=4000; 'SBDC3_6'=5000; 'SBDC3_7'=7500;
                              'SBDC3_8'=10000; 'SBDC3_9'=15000; 'SBDC3_10'=20000; 'SBDC3_11'=25000;
                              'SBDC3_12'=30000; 'SBDC3_13'=40000; 'SBDC3_14'=50000; 'SBDC3_15'=75000")
colnames(data_SBDC3_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC3_long$Choice <- as.factor(data_SBDC3_long$Choice)
data_SBDC3_long$Compensation <- as.numeric(as.character(data_SBDC3_long$Compensation))
data_SBDC3_long$Log_Comp <- log(data_SBDC3_long$Compensation)
data_SBDC3_long <- merge(data_SBDC3_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC3_long <- filter(data_SBDC3_long, CarOwner==1)

```

### Base panel model (intercept and compensation only)
```{r sbdc_basemod, warning = FALSE}
#SBDC1.
#  with panel effects (individuals answer multiple choice questions so we expect correlations among error terms)
logit1.p <- pglm(Choice ~ Log_Comp, 
                 data = data_SBDC1_long, family = "binomial", 
                 effect="individual", model="random", index="ResponseId")
summary(logit1.p)
confint(logit1.p)

b0.1 <- logit1.p$estimate[1]
bC.1 <- logit1.p$estimate[2]
medianWTAC.1 <- exp(-b0.1/bC.1)
medianWTAC.1

#BOOTSTRAPPING for confidence interval
#Modified from: https://stackoverflow.com/questions/54749641/bootstrapping-with-glm-model
nboot <- 1000 #number of iterations
bootsize <- 1500 #number of bootstrap samples, drawn with replacement

set.seed(101)
bres.1 <- matrix(NA,nrow=nboot,
                  ncol=length(coef(logit1.p)),
                  dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit1.p))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC1_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC1_long, ResponseId %in% rand.ids)
  bfit <- update(logit1.p, data=bdat)  ## refit with new data
  bres.1[i,] <- coef(bfit)
}

bres.1 <- data.frame(bres.1)
colnames(bres.1) <- c("b0.1", "bC.1", "sigma.1")
bres.1 <- bres.1 %>% mutate(medianWTAC.1 = exp(-b0.1/bC.1))

confint.1 <- data.frame(mean_est=colMeans(bres.1),
      t(apply(bres.1, 2, quantile, c(0.025,0.975))))
confint.1


#SBDC2.
logit2.p <- pglm(Choice ~ Log_Comp, 
                 data = data_SBDC2_long, family = "binomial", 
                 effect="individual", model="random", index="ResponseId")
summary(logit2.p)
confint(logit2.p)

b0.2 <- logit2.p$estimate[1]
bC.2 <- logit2.p$estimate[2]
medianWTAC.2 <- exp(-b0.2/bC.2)
medianWTAC.2

set.seed(201)
bres.2 <- matrix(NA,nrow=nboot,
                    ncol=length(coef(logit2.p)),
                    dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit2.p))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC2_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC2_long, ResponseId %in% rand.ids)
  bfit <- update(logit2.p, data=bdat)  ## refit with new data
  bres.2[i,] <- coef(bfit)
}

bres.2 <- data.frame(bres.2)
colnames(bres.2) <- c("b0.2", "bC.2", "sigma.2")
bres.2 <- bres.2 %>% mutate(medianWTAC.2 = exp(-b0.2/bC.2))

confint.2 <- data.frame(mean_est=colMeans(bres.2),
      t(apply(bres.2, 2, quantile, c(0.025,0.975))))
confint.2


#SBDC3.
logit3.p <- pglm(Choice ~ Log_Comp, 
                 data = filter(data_SBDC3_long, CarOwner==1), family = "binomial", 
                 effect="individual", model="random", index="ResponseId")
summary(logit3.p)
confint(logit3.p)

b0.3 <- logit3.p$estimate[1]
bC.3 <- logit3.p$estimate[2]
medianWTAC.3 <- exp(-b0.3/bC.3)
medianWTAC.3

set.seed(301)
bres.3 <- matrix(NA,nrow=nboot,
                    ncol=length(coef(logit3.p)),
                    dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit3.p))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC3_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC3_long, ResponseId %in% rand.ids)
  bfit <- update(logit3.p, data=bdat)  ## refit with new data
  bres.3[i,] <- coef(bfit)
}

bres.3 <- data.frame(bres.3)
colnames(bres.3) <- c("b0.3", "bC.3", "sigma.3")
bres.3 <- bres.3 %>% mutate(medianWTAC.3 = exp(-b0.3/bC.3))

confint.3 <- data.frame(mean_est=colMeans(bres.3),
      t(apply(bres.3, 2, quantile, c(0.025,0.975))))
confint.3

```


### Models with all predictors
Now let's include all of the independent variables in the models, including build environment/city, individual sociodemographics, household composition and car ownership, typical travle behavior, ability to use modes, and employer transportation benefits. 

```{r sbdc_fullmod, warning = FALSE}
#SBDC1
logit1.p.full <- pglm(Choice ~ Log_Comp + Rural + Urban + WashingtonDC + Chicago + Seattle + 
                        Male + Age + White + Hispanic + ColDeg + AdvDeg + FullTime +
                        HHInc + HHChild + HHWkAdult +
                        OneCar + NoCar + 
                        ModeTravel_Typical_NMT + ModeTravel_Typical_PT + ModeTravel_Typical_car + ModeTravel_Typical_RH + 
                        UnableBicycle + UnableCar + UnablePT + UnableRH + 
                        EmpBenParking + EmpBenTransit + EmpBenBike + EmpBenCarpool,
                    data = data_SBDC1_long, family = "binomial", 
                    effect = "individual", model = "random", index = "ResponseId")
summary(logit1.p.full)

#Raw coefficients (b) are the change in the log-likelihood log(p/1-p) of giving up ridehailing
#Store the estimated coefficients
b0.1 <- logit1.p.full$estimate[1]
bC.1 <- logit1.p.full$estimate[2]
bR.1 <- logit1.p.full$estimate[3]
bU.1 <- logit1.p.full$estimate[4]
bWash.1  <- logit1.p.full$estimate[5]
bChi.1  <- logit1.p.full$estimate[6]
bSeat.1 <- logit1.p.full$estimate[7]
bMale.1 <- logit1.p.full$estimate[8]
bAge.1 <- logit1.p.full$estimate[9]
bWhite.1 <- logit1.p.full$estimate[10]
bHisp.1 <- logit1.p.full$estimate[11]
bCol.1 <- logit1.p.full$estimate[12]
bAdvD.1 <- logit1.p.full$estimate[13]
bFT.1 <- logit1.p.full$estimate[14]
bInc.1 <- logit1.p.full$estimate[15]
bHHChild.1 <- logit1.p.full$estimate[16]
bHHWkAd.1 <- logit1.p.full$estimate[17]
bOneCar.1 <- logit1.p.full$estimate[18]
bNoCar.1 <- logit1.p.full$estimate[19]
bNMTuse.1 <- logit1.p.full$estimate[20]
bPTuse.1 <- logit1.p.full$estimate[21]
bCaruse.1 <- logit1.p.full$estimate[22]
bRHuse.1 <- logit1.p.full$estimate[23]
bUnBike.1 <- logit1.p.full$estimate[24]
bUnCar.1 <- logit1.p.full$estimate[25]
bUnPT.1 <- logit1.p.full$estimate[26]
bUnRH.1 <- logit1.p.full$estimate[27]
bEmpBPark.1 <- logit1.p.full$estimate[28]
bEmpBTrans.1 <- logit1.p.full$estimate[29]
bEmpBBike.1 <- logit1.p.full$estimate[30]
bEmpBPool.1 <- logit1.p.full$estimate[31]

#Calculate Ci for each individual based on estimated coefficients (general) and each individual's specific sociodemographics
data_sociodem <- data_sociodem %>% mutate(SBDC1_Ci = ifelse(UsedRH==0, NA, 
                                                     exp(-(b0.1 + 
                                                            bR.1 * Rural + 
                                                            bU.1 * Urban +
                                                            bWash.1 * WashingtonDC + 
                                                            bChi.1 * Chicago + 
                                                            bSeat.1 * Seattle + 
                                                            bMale.1 * Male + 
                                                            bAge.1 * Age + 
                                                            bWhite.1 * White + 
                                                            bHisp.1 * Hispanic + 
                                                            bCol.1 * ColDeg + 
                                                            bAdvD.1 * AdvDeg + 
                                                            bFT.1 * FullTime + 
                                                            bInc.1 * HHInc + 
                                                            bHHChild.1 * HHChild + 
                                                            bHHWkAd.1 * HHWkAdult + 
                                                            bOneCar.1 * OneCar + 
                                                            bNoCar.1 * NoCar + 
                                                            bNMTuse.1 * ModeTravel_Typical_NMT +
                                                            bPTuse.1 * ModeTravel_Typical_PT + 
                                                            bCaruse.1 * ModeTravel_Typical_car + 
                                                            bRHuse.1 * ModeTravel_Typical_RH + 
                                                            bUnBike.1 * UnableBicycle + 
                                                            bUnCar.1 * UnableCar + 
                                                            bUnPT.1 * UnablePT + 
                                                            bUnRH.1 * UnableRH + 
                                                            bEmpBPark.1 * EmpBenParking + 
                                                            bEmpBTrans.1 * EmpBenTransit + 
                                                            bEmpBBike.1 * EmpBenBike + 
                                                            bEmpBPool.1 * EmpBenCarpool)/bC.1)))

#Calculate the average indifference point compensation (median WTAC) across all individuals
summary(data_sociodem$SBDC1_Ci) #1201 systematic missing from individuals who had not used ridehailing

# SBDC2
logit2.p.full <- pglm(Choice ~ Log_Comp + Rural + Urban + WashingtonDC + Chicago + Seattle + 
                        Male + Age + White + Hispanic + ColDeg + AdvDeg + FullTime +
                        HHInc + HHChild + HHWkAdult + OneCar + 
                        ModeTravel_Typical_PT + ModeTravel_Typical_car + ModeTravel_Typical_NMT + ModeTravel_Typical_RH +
                        UnableBicycle + UnableCar + UnablePT + UnableRH + 
                        EmpBenParking + EmpBenTransit + EmpBenBike + EmpBenCarpool,
                    data = data_SBDC2_long, family = "binomial", 
                    effect = "individual", model = "random", index = "ResponseId")
summary(logit2.p.full)

#Store the estimated coefficients
b0.2 <- logit2.p.full$estimate[1]
bC.2 <- logit2.p.full$estimate[2]
bR.2 <- logit2.p.full$estimate[3]
bU.2 <- logit2.p.full$estimate[4]
bWash.2  <- logit2.p.full$estimate[5]
bChi.2  <- logit2.p.full$estimate[6]
bSeat.2 <- logit2.p.full$estimate[7]
bMale.2 <- logit2.p.full$estimate[8]
bAge.2 <- logit2.p.full$estimate[9]
bWhite.2 <- logit2.p.full$estimate[10]
bHisp.2 <- logit2.p.full$estimate[11]
bCol.2 <- logit2.p.full$estimate[12]
bAdvD.2 <- logit2.p.full$estimate[13]
bFT.2 <- logit2.p.full$estimate[14]
bInc.2 <- logit2.p.full$estimate[15]
bHHChild.2 <- logit2.p.full$estimate[16]
bHHWkAd.2 <- logit2.p.full$estimate[17]
bOneCar.2 <- logit2.p.full$estimate[18]
bPTuse.2 <- logit2.p.full$estimate[19]
bCaruse.2 <- logit2.p.full$estimate[20]
bNMT.2 <- logit1.p.full$estimate[21]
bRH.2 <- logit1.p.full$estimate[22]
bUnBike.2 <- logit2.p.full$estimate[23]
bUnCar.2 <- logit2.p.full$estimate[24]
bUnPT.2 <- logit2.p.full$estimate[25]
bUnRH.2 <- logit2.p.full$estimate[26]
bEmpBPark.2 <- logit2.p.full$estimate[27]
bEmpBTrans.2 <- logit2.p.full$estimate[28]
bEmpBBike.2 <- logit2.p.full$estimate[29]
bEmpBPool.2 <- logit2.p.full$estimate[30]

#Calculate Ci for each individual based on estimated coefficients (general) and each individual's specific sociodemographics
data_sociodem <- data_sociodem %>% mutate(SBDC2_Ci = ifelse(CarOwner==0, NA, exp(-(b0.2 + bR.2 * Rural + bU.2 * Urban + bWash.2 * WashingtonDC + bChi.2 * Chicago + bSeat.2 * Seattle + bInc.2 * HHInc + bHHChild.2 * HHChild + bHHWkAd.2 * HHWkAdult + bMale.2 * Male + bAge.2 * Age + bWhite.2 * White + bHisp.2 * Hispanic + bCol.2 * ColDeg + bAdvD.2 * AdvDeg + bFT.2 * FullTime + bOneCar.2 * OneCar + bPTuse.2 * ModeTravel_Typical_PT + bCaruse.2 * ModeTravel_Typical_car + bNMT.2 * ModeTravel_Typical_NMT + bRH.2 *  ModeTravel_Typical_RH + bUnBike.2 * UnableBicycle + bUnCar.2 * UnableCar + bUnPT.2 * UnablePT + bUnRH.2 * UnableRH + bEmpBPark.2 * EmpBenParking + bEmpBTrans.2 * EmpBenTransit + bEmpBBike.2 * EmpBenBike + bEmpBPool.2 * EmpBenCarpool)/bC.2)))

#Calculate the average indifference point compensation (median WTAC) across all individuals
summary(data_sociodem$SBDC2_Ci) 



#SBDC3.
logit3.p.full <- pglm(Choice ~ Log_Comp + Rural + Urban + WashingtonDC + Chicago + Seattle + 
                        Male + Age + White + Hispanic + ColDeg + AdvDeg + FullTime +
                        HHInc + HHChild + HHWkAdult + OneCar +
                        ModeTravel_Typical_PT + ModeTravel_Typical_car + ModeTravel_Typical_NMT + ModeTravel_Typical_RH +
                        UnableBicycle + UnableCar + UnablePT + UnableRH + 
                        EmpBenParking + EmpBenTransit + EmpBenBike + EmpBenCarpool,
                    data = data_SBDC3_long, family = "binomial", 
                    effect = "individual", model = "random", index = "ResponseId")
summary(logit3.p.full)

#Store the estimated coefficients
b0.3 <- logit3.p.full$estimate[1]
bC.3 <- logit3.p.full$estimate[2]
bR.3 <- logit3.p.full$estimate[3]
bU.3 <- logit3.p.full$estimate[4]
bWash.3  <- logit3.p.full$estimate[5]
bChi.3  <- logit3.p.full$estimate[6]
bSeat.3 <- logit3.p.full$estimate[7]
bMale.3 <- logit3.p.full$estimate[8]
bAge.3 <- logit3.p.full$estimate[9]
bWhite.3 <- logit3.p.full$estimate[10]
bHisp.3 <- logit3.p.full$estimate[11]
bCol.3 <- logit3.p.full$estimate[12]
bAdvD.3 <- logit3.p.full$estimate[13]
bFT.3 <- logit3.p.full$estimate[14]
bInc.3 <- logit3.p.full$estimate[15]
bHHChild.3 <- logit3.p.full$estimate[16]
bHHWkAd.3 <- logit3.p.full$estimate[17]
bOneCar.3 <- logit3.p.full$estimate[18]
bPTuse.3 <- logit3.p.full$estimate[19]
bCaruse.3 <- logit3.p.full$estimate[20]
bNMT.3 <- logit3.p.full$estimate[21]
bRH.3 <- logit3.p.full$estimate[22]
bUnBike.3 <- logit3.p.full$estimate[23]
bUnCar.3 <- logit3.p.full$estimate[24]
bUnPT.3 <- logit3.p.full$estimate[25]
bUnRH.3 <- logit3.p.full$estimate[26]
bEmpBPark.3 <- logit3.p.full$estimate[27]
bEmpBTrans.3 <- logit3.p.full$estimate[28]
bEmpBBike.3 <- logit3.p.full$estimate[29]
bEmpBPool.3 <- logit3.p.full$estimate[30]


#Calculate Ci for each individual based on estimated coefficients (general) and each individual's specific sociodemographics
data_sociodem <- data_sociodem %>% mutate(SBDC3_Ci = ifelse(CarOwner==0, NA, exp(-(b0.3 + bR.3 * Rural + bU.3 * Urban + bWash.3 * WashingtonDC + bChi.3 * Chicago + bSeat.3 * Seattle + bMale.3 * Male + bAge.3 * Age + bWhite.3 * White + bHisp.3 * Hispanic + bCol.3 * ColDeg + bAdvD.3 * AdvDeg + bFT.3 * FullTime + bInc.3 * HHInc + bHHChild.3 * HHChild + bHHWkAd.3 * HHWkAdult + bOneCar.3 * OneCar + bPTuse.3 * ModeTravel_Typical_PT + bCaruse.3 * ModeTravel_Typical_car + bNMT.3 * ModeTravel_Typical_NMT + bRH.3 * ModeTravel_Typical_RH + bUnBike.3 * UnableBicycle + bUnCar.3 * UnableCar + bUnPT.3 * UnablePT + bUnRH.3 * UnableRH + bEmpBPark.3 * EmpBenParking + bEmpBTrans.3 * EmpBenTransit + bEmpBBike.3 * EmpBenBike + bEmpBPool.3 * EmpBenCarpool)/bC.3)))

#Calculate the average indifference point compensation (median WTAC) across all individuals
summary(data_sociodem$SBDC3_Ci) #235 systematic NAs from non-car owners; 2 additional NAs from urban/rural merge

#value of car use = SBDC2_Ci - SBDC3_Ci
data_sociodem$SBDCdiff_Ci <- data_sociodem$SBDC2_Ci - data_sociodem$SBDC3_Ci
summary(data_sociodem$SBDCdiff_Ci)

```



# Descriptive Analysis

```{r scatter, warning=FALSE}
#HHTransportCosts_1 "In a typical month before the coronavirus pandemic, how much did your household spend on transportation-related costs not including long distance travel? (in hundreds of dollars)"

#For non-car owners:
#NoCar_estcostwithcar_1	"If your household owned one car, what do you estimate your average monthly household transportation costs would be? (in hundreds of dollars)"

#For car-owners:
#CarOwn_cost_1	"Please estimate how much your household spends on car ownership in a typical month (in hundreds of dollars)."

### Household transportation costs with and without a car
data_gc <- data_gc %>% mutate(HHTransportCosts = as.numeric(HHTransportCosts_1)*100*12, #convert to units of $ and from month to year
                              NoCar_EstCost = as.numeric(NoCar_estcostwithcar_1)*100*12,
                              CarOwn_Cost = as.numeric(CarOwn_cost_1)*100*12,
                              CarCost_perCar = ifelse(HHCars==0, NA, CarOwn_Cost / HHCars))
data_sociodem <- merge(data_sociodem, subset(data_gc, select=c("ResponseId", "HHTransportCosts", "NoCar_EstCost", "CarOwn_Cost", "CarCost_perCar")), by="ResponseId")

length(which(data_sociodem$CarOwn_Cost < data_sociodem$SBDC2_Ci))/nrow(data_sociodem)
length(which(data_sociodem$CarCost_perCar < data_sociodem$SBDC2_Ci))/nrow(data_sociodem)

#Assuming individuals underestimate cost of car ownership by ~52% (Andor, et al. 2020)
length(which(data_sociodem$CarOwn_Cost*1.5 < data_sociodem$SBDC2_Ci))/nrow(data_sociodem) 
length(which(data_sociodem$CarCost_perCar*1.5 < data_sociodem$SBDC2_Ci))/nrow(data_sociodem) 

ggplot(data_sociodem, aes(x=CarOwn_Cost, y=SBDC2_Ci)) +
  geom_point() + 
  geom_abline(intercept=0, slope=1, color="blue") + #add y = x line
  geom_abline(intercept=0, slope=1.5, color="green") + #add y = 1.5x line
  #geom_smooth(method=lm, se=FALSE) + #add linear regression line
  #scale_y_continuous(limits = c(0, 60000)) + #converts all values outside the range to NA.
  coord_cartesian(ylim=c(0,60000), xlim=c(-50, 18050), expand=FALSE) + #includes all outliers
  xlab("Self-reported household car costs for a typical year") + ylab("Estimated individual indifference compensation for giving up \n access to car ownership and use for a year (Scenario 2)") +
  theme_bw()

ggsave(filename="ValueCost_scatter.jpg", plot=last_plot(), height=4.5, width=7, units="in", dpi=800)

```

## Self-reported minimum compensation
* DirVal_RH_1: "How much would you need to be paid (minimum acceptable amount) for you to give up all access to taxi and ride-hailing services for one year?"
* DirVal_Scn2_1: "Given all of your travel needs and options in a typical year, how much would you need to be paid (minimum acceptable amount) for you to give up access to your primary vehicle for one year?"
* DirVal_Scn3_1: "Assume you are given free access to a ride-hailing service that could serve all of the trips that you typically make by car. How much would you need to be paid (minimum acceptable amount) for you to give up access to your primary vehicle for one year?"

As we might expect, we see that self-reported minimum compensation amounts are much higher than those estimated using SBDC.

```{r}
data_gc <- data_gc %>% mutate(DirVal_RH = as.numeric(DirVal_RH_1),
                              DirVal_Scen2 = as.numeric(DirVal_Scn2_1)*1000,
                              DirVal_Scen3 = as.numeric(DirVal_Scn3_1)*1000) #convert to units of $
data_sociodem <- merge(data_sociodem, subset(data_gc, select=c("ResponseId", "DirVal_RH", "DirVal_Scen2", "DirVal_Scen3")), by="ResponseId")


#Scenario 1. Give up ridehailing for a year under current conditions
summary(data_sociodem$DirVal_RH)
cor(data_sociodem$DirVal_RH, data_sociodem$SBDC1_Ci, use="pairwise.complete.obs")


#Scenario 2. Give up private car for a year under current conditions (ownership and use)
summary(data_sociodem$DirVal_Scen2)
ggplot(data_sociodem, aes(y=SBDC2_Ci, x=DirVal_Scen2)) +
  geom_point() + 
  geom_abline(intercept=0, slope=1, color="blue") +
  #scale_y_continuous(limits = c(0, 60000)) + #converts all values outside the range to NA.
  coord_cartesian(ylim=c(-200,75200), xlim=c(-200, 75200), expand=FALSE) + #includes all outliers
  ggtitle("Scenario 2. Give up private car for a year under current conditions") +
  ylab("Estimated individual indifference compensation") + xlab("Self-reported minimum acceptable compensation)") +
  theme_bw()


length(which(data_sociodem$CarOwn_Cost < data_sociodem$DirVal_Scen2))/nrow(data_sociodem)
#88% of individuals say they would need to be compensated more than they say car ownership costs in order to give up their primary vehicle

ggplot(data_sociodem, aes(x=CarOwn_Cost, y=DirVal_Scen2)) +
  geom_point() + 
  geom_abline(intercept=0, slope=1, color="blue") + #add y = x line
  #geom_smooth(method=lm, se=FALSE) + #add linear regression line
  #scale_y_continuous(limits = c(0, 60000)) + #converts all values outside the range to NA.
  coord_cartesian(ylim=c(0,75000), xlim=c(-50, 18050), expand=FALSE) + #includes all outliers
  xlab("Self-reported household car ownership costs for a typical year") + ylab("Self-reported minimum acceptable amount to give up access \n to primary vehicle for a year under current conditions (Scenario 2)") +
  theme_bw()


#Scenario 3. Give up private car for a year with unlimited ridehailing to replace use (ownership only)
summary(data_sociodem$DirVal_Scen3)
ggplot(data_sociodem, aes(y=SBDC3_Ci, x=DirVal_Scen3)) +
  geom_point() + 
  geom_abline(intercept=0, slope=1, color="blue") +
  #scale_y_continuous(limits = c(0, 60000)) + #converts all values outside the range to NA.
  coord_cartesian(ylim=c(-200,75200), xlim=c(-200, 75200), expand=FALSE) + #includes all outliers
  ggtitle("Scenario 3. Give up private car for a year with unlimited ridehailing") +
  ylab("Estimated individual indifference compensation") + xlab("Self-reported minimum acceptable compensation)") +
  theme_bw()

```


## Non-car-owners
```{r nocar, warning=FALSE}
data_NoCar <- filter(data_gc, NoCar==1)

### Reasons for not owning a car

#NoCar_Reasons: "What are the three most important reasons for why you do not own a car?"
#  It is unaffordable
#  It is more convenient to use non-car transportation options
#  Environmental reasons
#  Finding parking is too expensive or inconvenient
#  I don't know how to drive or am not comfortable driving
#  I am physically unable to drive
#  I have easy access to borrowing a car
#  Other

#What did people write-in for "Other"?
unique(data_NoCar$NoCar_Reasons_7_TEXT)

data_NoCar <- data_NoCar %>% mutate(
  NoCar_Reasons_7_TEXT = replace_na(NoCar_Reasons_7_TEXT, 0),
  NoCarReason_Cost = as.integer(str_detect(NoCar_Reasons, "It is unaffordable")) +
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "Too many bills involved")) +
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "I  can't afford one")) +
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "Can't borrow money")) +
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "Money to buy one")) + 
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "I donâ€™t need the added expense")) + 
                     as.integer(str_detect(NoCar_Reasons_7_TEXT, "I can drive but can't afford an accessible vehicle that I can dribe")),
  NoCarReason_Alter = as.integer(str_detect(NoCar_Reasons, "It is more convenient to use non-car transportation options"))+
                      as.integer(str_detect(NoCar_Reasons_7_TEXT, "Public transportation is excellent  and rental cars are close by")) +
                      as.integer(str_detect(NoCar_Reasons_7_TEXT, "prefer walking")) +
                      as.integer(str_detect(NoCar_Reasons_7_TEXT, "I get my exercise by walking to and from the bustop and walking everywhere I need to go")) +
                      as.integer(str_detect(NoCar_Reasons_7_TEXT, "easy use of lyft/uber")),
  NoCarReason_Disable = as.integer(str_detect(NoCar_Reasons, "I am physically unable to drive")) + 
                        as.integer(str_detect(NoCar_Reasons_7_TEXT, "I'm disabled")) +
                        as.integer(str_detect(NoCar_Reasons_7_TEXT, "Medical")),
  NoCarReason_Park = as.integer(str_detect(NoCar_Reasons, "Finding parking is too expensive or inconvenient")),
  NoCarReason_Envir = as.integer(str_detect(NoCar_Reasons, "Environmental reasons")),
  NoCarReason_Access = as.integer(str_detect(NoCar_Reasons, "I have easy access to borrowing a car")) +
                       as.integer(str_detect(NoCar_Reasons_7_TEXT, "Get rides with friends and family")),
  NoCarReason_KnowHow = as.integer(str_detect(NoCar_Reasons, "I don't know how to drive or am not comfortable driving")) +
                        as.integer(str_detect(NoCar_Reasons_7_TEXT, "Not comfortable driving in this city or at this age, as a beginner.")) +
                        as.integer(str_detect(NoCar_Reasons_7_TEXT, "I am waiting for my provisonal liciense to convert over to a full drivers licience")) +
                        as.integer(str_detect(NoCar_Reasons_7_TEXT, "license"))
)

NoCarReason_vars <- c("NoCarReason_Cost", "NoCarReason_Alter", "NoCarReason_Disable", "NoCarReason_Park", "NoCarReason_Envir", "NoCarReason_Access", "NoCarReason_KnowHow")

NoCarReason_text <- c("It is unaffordable", "It is more convenient [or I prefer] to use \n non-car transportation options", "I am physically [or medically] unable to drive", "Finding parking is too expensive or inconvenient", "Environmental reasons", "I have easy access to borrowing a car", "I don't know how to drive or am not comfortable \n driving [including not having a license]")

NoCarReason_df <- subset(data_NoCar, select=NoCarReason_vars)
NoCarReason_sums <- t(NoCarReason_df %>% summarise_all(function(x) sum(x)))
NoCarReason_sums_df <- data.frame(NoCarReason_text, NoCarReason_sums) 

NoCarReason_sums_df <- NoCarReason_sums_df %>% mutate(NoCarReason_text = fct_reorder(NoCarReason_text, NoCarReason_sums, .desc=FALSE))
ggplot(data=NoCarReason_sums_df)+
  geom_col(aes(x=NoCarReason_text, y=NoCarReason_sums))+
  ggtitle("Reasons for not owning a car")+
  xlab(" ") + 
  ylab("Number of respondents who select each reason as important")+
  theme_bw()+
  coord_flip()

ggsave(filename="NoCar_Reasons.jpg", plot=last_plot(), height=5, width=8, units="in", dpi=800)



### Household transportation costs with and without a car
data_NoCar <- data_NoCar %>% mutate(HHTransportCosts_1 = as.numeric(HHTransportCosts_1)*100,
                                    NoCar_estcostwithcar_1 = as.numeric(NoCar_estcostwithcar_1)*100,
                                    NoCar_estcostdiff = NoCar_estcostwithcar_1 - HHTransportCosts_1)


#HHTransportCosts_1 "In a typical month before the coronavirus pandemic, how much did your household spend on transportation-related costs not including long distance travel? (in hundreds of dollars)"
summary(data_NoCar$HHTransportCosts_1)

p_wo <- ggplot(data_NoCar) + 
        geom_histogram(aes(x=HHTransportCosts_1), bins=20) +
        xlab("Estimated household transport costs WITHOUT car") +
        ylab("Number of respondents") +
        theme_bw()

#NoCar_estcostwithcar_1	If your household owned one car, what do you estimate your average monthly household transportation costs would be? (in hundreds of dollars)
summary(data_NoCar$NoCar_estcostwithcar_1)

p_with <- ggplot(data_NoCar) + 
          geom_histogram(aes(x=HHTransportCosts_1), bins=20) +
          xlab("Estimated household transport costs WITH car") +
          ylab("Number of respondents") +
          theme_bw()

p_diff <- ggplot(data_NoCar) + 
          geom_histogram(aes(x=NoCar_estcostdiff), bins=20) +
          xlab("Difference in estimated household transport costs \n WITH - WITHOUT car") +
          ylab("Number of respondents") +
          theme_bw()

grid.arrange(p_wo, p_with, p_diff, nrow=2)

p_diff2 <- ggplot(data_NoCar) + 
          geom_histogram(aes(x=NoCar_estcostdiff, group=NoCar_Pref, fill=NoCar_Pref), 
                         alpha=0.6, position = 'identity', bins=20) +
          xlab("Difference in estimated household transport costs \n WITH - WITHOUT car") +
          ylab("Number of respondents") +
          scale_fill_viridis("Would you prefer to own \n a car if you could?", discrete=TRUE)+
          theme_bw()
p_diff2


#NoCar_Pref: "Would you prefer to own a car if you could?"
data_NoCar <- data_NoCar %>% mutate(NoCar_Pref = ifelse(NoCar_Pref == "Yes", 1, 0))
summary(data_NoCar$NoCar_Pref)

#NoCar_PurchInt	Do you or another member of your household intend to purchase a car in the future?

```

## Car-owners
```{r carown, warning=FALSE}
data_CarOwn <- filter(data_gc, CarOwner==1)

### Reasons for being reluctant to give up your vehicle

#Q165: "What are the three most important reasons why you would be reluctant to give up your primary vehicle?"
#  My car is the cheapest alternative for me
#  My car is the fastest alternative for me
#  Need to transport other people (children, elderly relatives, etc.)
#  Need to transport goods or equipment
#  Need for storage space
#  Certainty and reliability of being able to use my own car at any time, any place
#  The flexibility the car provides
#  Control over my own travel schedule that my own car provides
#  Communication of status or values
#  Sentimental attachment
#  Comfort with using my own car compared to using other modes
#  Cleanliness of my car compared to other modes
#  The safety and security from using my own car compared to using other modes
#  The privacy that using my car provides
#  Other

#What did people write-in for "Other"?
unique(data_CarOwn$Q165_11_TEXT)

data_CarOwn <- data_CarOwn %>% mutate(
  Q165_1 = as.integer(str_detect(Q165, "My car is the cheapest alternative for me")),
  Q165_2 = as.integer(str_detect(Q165, "My car is the fastest alternative for me")),
  Q165_3 = as.integer(str_detect(Q165, "Need to transport other people")),
  Q165_4 = as.integer(str_detect(Q165, "Need to transport goods or equipment")),
  Q165_5 = as.integer(str_detect(Q165, "Need for storage space")),
  Q165_6 = as.integer(str_detect(Q165, "Certainty and reliability of being able to use my own car at any time, any place")),
           #+ as.integer(str_detect(Q165_11_TEXT, "emergency")),
  Q165_7 = as.integer(str_detect(Q165, "The flexibility the car provides")),
  Q165_8 = as.integer(str_detect(Q165, "Control over my own travel schedule that my own car provides")),
  Q165_9 = as.integer(str_detect(Q165, "Communication of status or values")),
  Q165_10 = as.integer(str_detect(Q165, "Sentimental attachment")),
  Q165_11 = as.integer(str_detect(Q165, "Comfort with using my own car compared to using other modes")),
  Q165_12 = as.integer(str_detect(Q165, "Cleanliness of my car compared to other modes")),
  Q165_13 = as.integer(str_detect(Q165, "The safety and security from using my own car compared to using other modes")),
  Q165_14 = as.integer(str_detect(Q165, "The privacy that using my car provides")),
  Q165_15 = as.integer(str_detect(Q165, "Other"))     
)

KeepCarReason_vars <- c("Q165_1", "Q165_2", "Q165_3", "Q165_4", "Q165_5", "Q165_6", "Q165_7", "Q165_8", 
                        "Q165_9", "Q165_10", "Q165_11", "Q165_12", "Q165_13", "Q165_14", "Q165_15")

KeepCarReason_text <- c("My car is the cheapest alternative for me", "My car is the fastest alternative for me", "Need to transport other people (children, elderly relatives, etc.)", "Need to transport goods or equipment", "Need for storage space", "Certainty and reliability of being able to use my own car at any time, any place", "The flexibility the car provides", "Control over my own travel schedule that my own car provides", "Communication of status or values", "Sentimental attachment", "Comfort with using my own car compared to using other modes", "Cleanliness of my car compared to other modes", "The safety and security from using my own car compared to using other modes", "The privacy that using my car provides", "Other")

KeepCarReason_df <- subset(data_CarOwn, select=KeepCarReason_vars)
KeepCarReason_sums <- t(KeepCarReason_df %>% summarise_all(function(x) sum(x)))
KeepCarReason_sums_df <- data.frame(KeepCarReason_text, KeepCarReason_sums) 

KeepCarReason_sums_df <- KeepCarReason_sums_df %>% mutate(KeepCarReason_text = fct_reorder(KeepCarReason_text, KeepCarReason_sums, .desc=FALSE))
ggplot(data=KeepCarReason_sums_df)+
  geom_col(aes(x=KeepCarReason_text, y=KeepCarReason_sums))+
  ggtitle("Reasons for reluctance to give up car")+
  xlab(" ") + 
  ylab("Number of respondents who select each reason as important")+
  theme_bw()+
  coord_flip()

ggsave(filename="YesCar_Reasons.jpg", plot=last_plot(), height=5, width=9, units="in", dpi=600)

```


##Summarize/visualize by sociodemographic group
```{r}
data_sociodem.U <- filter(data_sociodem, Urban==1)
data_sociodem.R <- filter(data_sociodem, Rural==1)
data_sociodem.S <- filter(data_sociodem, Suburban==1)

data_sociodem.Wash <- filter(data_sociodem, WashingtonDC==1)
data_sociodem.Chi <- filter(data_sociodem, Chicago==1)
data_sociodem.Seat <- filter(data_sociodem, Seattle==1)
data_sociodem.Dall <- filter(data_sociodem, Dallas==1)


###Urban/Suburban/Rural
summary(data_sociodem.U$SBDC1_Ci)
summary(data_sociodem.R$SBDC1_Ci)
summary(data_sociodem.S$SBDC1_Ci)

summary(data_sociodem.U$SBDC2_Ci)
summary(data_sociodem.R$SBDC2_Ci)
summary(data_sociodem.S$SBDC2_Ci)
# $11,326 for urban respondents, $15,646 for suburban respondents, and $18,676 for rural respondents

summary(data_sociodem.U$SBDC3_Ci)
summary(data_sociodem.R$SBDC3_Ci)
summary(data_sociodem.S$SBDC3_Ci)
# $11,326 for urban respondents, $15,646 for suburban respondents, and $18,676 for rural respondents

Ci_medians_USR <- data_sociodem %>% 
  group_by(Urban...Suburban...Rural) %>% 
    summarise(Med1 = median(SBDC1_Ci, na.rm=TRUE),
              Med2 = median(SBDC2_Ci, na.rm=TRUE),
              Med3 = median(SBDC3_Ci, na.rm=TRUE))

Ci_means_USR <- data_sociodem %>% 
  group_by(Urban...Suburban...Rural) %>% 
    summarise(Mn1 = mean(SBDC1_Ci, na.rm=TRUE),
              Mn2 = mean(SBDC2_Ci, na.rm=TRUE),
              Mn3 = mean(SBDC3_Ci, na.rm=TRUE))

ggplot(data=filter(data_sociodem, is.na(Urban...Suburban...Rural)==FALSE), aes(x=Urban...Suburban...Rural, y=SBDC1_Ci, group=Urban...Suburban...Rural)) +
  geom_boxplot()+
  ggtitle("") +
  xlab("Rural, Suburban, or Urban Home Zipcode") + ylab("Indifference Compensation (US$)") +
  theme_bw()

ggplot(data=filter(data_sociodem, is.na(Urban...Suburban...Rural)==FALSE), aes(x=Urban...Suburban...Rural, y=SBDC1_Ci, group=Urban...Suburban...Rural)) +
  geom_boxplot()+
  geom_text(data=filter(Ci_medians_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Med1, label = round(Med1,0)), position = position_dodge(width = 0.8), size=3, vjust=0.9) +
  geom_point(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn1), color="blue", shape=8) +
  geom_text(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn1, label=round(Mn1,0)), color="blue", position=position_dodge(width=0.8), size=3, vjust=-0.9) +
  ggtitle("Scenario 1. Value of ridehailing access for a year") +
  xlab("Rural, Suburban, or Urban Home Zipcode") + ylab("Indifference Compensation (US$)") +
  theme_bw() + coord_cartesian(ylim=c(0,2000))

ggplot(data=filter(data_sociodem, is.na(Urban...Suburban...Rural)==FALSE), aes(x=Urban...Suburban...Rural, y=SBDC2_Ci, group=Urban...Suburban...Rural)) +
  geom_boxplot()+
  geom_text(data=filter(Ci_medians_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Med2, label = round(Med2,0)), position = position_dodge(width = 0.8), size=3, vjust=1.2) +
  geom_point(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn2), color="blue", shape=8) +
  geom_text(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn2, label=round(Mn2,0)), color="blue", position=position_dodge(width=0.8), size=3, vjust=-0.9) +
  ggtitle("Value of car ownership and use in a typical year") +
  xlab("Rural, Suburban, or Urban Home Zipcode") + ylab("Individual-specific indifference compensation (US$)") +
  coord_cartesian(ylim=c(0,50000)) +
  theme_bw()

ggsave(filename="BuiltEnv_BoxPlots.jpg", plot=last_plot(), height=6, width=7, units="in", dpi=800)


ggplot(data=filter(data_sociodem, is.na(Urban...Suburban...Rural)==FALSE), aes(x=Urban...Suburban...Rural, y=SBDC3_Ci, group=Urban...Suburban...Rural)) +
  geom_boxplot()+
  geom_text(data=filter(Ci_medians_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Med3, label = round(Med3,0)), position = position_dodge(width = 0.8), size=3, vjust=0.9) +
  geom_point(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn3), color="blue", shape=8) +
  geom_text(data=filter(Ci_means_USR, is.na(Urban...Suburban...Rural)==FALSE),aes(x=Urban...Suburban...Rural, y=Mn3, label=round(Mn3,0)), color="blue", position=position_dodge(width=0.8), size=3, vjust=-0.9) +
  ggtitle("Scenario 3. Value of car ownership for a year \n (car use fulfilled by ubiquitous ridehailing)") +
  xlab("Rural, Suburban, or Urban Home Zipcode") + ylab("Indifference Compensation (US$)") +
  theme_bw()

###CITY
summary(data_sociodem.Wash$SBDC1_Ci)
summary(data_sociodem.Chi$SBDC1_Ci)
summary(data_sociodem.Seat$SBDC1_Ci)
summary(data_sociodem.Dall$SBDC1_Ci)
# No statistically significant difference in probability of giving up car by city according to the model, but we do see different mean compensation amounts: Washington = $166, Chicago = $101, Seattle = $136, Dallas = $127

summary(data_sociodem.Wash$SBDC2_Ci)
summary(data_sociodem.Chi$SBDC2_Ci)
summary(data_sociodem.Seat$SBDC2_Ci)
summary(data_sociodem.Dall$SBDC2_Ci)
# No statistically significant difference in probability of giving up car by city according to the model, but we do see some differences in mean compensation amounts: Washington = $11,815, Chicago = $15,032, Seattle = $13,323, Dallas = $13,507
#^ these results generally agree with our interaction term model, which found that Chicago had the highest WTAC (without controls) and WashingtonDC had the lowest, with Seattle and Dallas both in the middle

summary(data_sociodem.Wash$SBDC3_Ci)
summary(data_sociodem.Chi$SBDC3_Ci)
summary(data_sociodem.Seat$SBDC3_Ci)
summary(data_sociodem.Dall$SBDC3_Ci)
# No statistically significant difference in probability of giving up car by city according to the model, but we do see some differences in mean compensation amounts: Washington = $11,815, Chicago = $15,032, Seattle = $13,323, Dallas = $13,507
#^ these results generally agree with our interaction term model, which found that Chicago had the highest WTAC (without controls) and WashingtonDC had the lowest, with Seattle and Dallas both in the middle




ggplot(data=data_sociodem, aes(x=DMA, y=SBDC1_Ci, group=DMA)) +
  geom_boxplot()+
  ggtitle("Scenario 1. Value of ridehailing access for a year") +
  xlab("City") + ylab("Indifference Compensation (US$)") +
  theme_bw()

ggplot(data=data_sociodem, aes(x=DMA, y=SBDC2_Ci, group=DMA)) +
  geom_boxplot()+
  ggtitle("Scenario 2. Value of car ownership and use for a year") +
  xlab("City") + ylab("Indifference Compensation (US$)") +
  coord_cartesian(ylim=c(0,50000)) +
  theme_bw()

ggplot(data=data_sociodem, aes(x=DMA, y=SBDC3_Ci, group=DMA)) +
  geom_boxplot()+
  ggtitle("Scenario 3. Value of car ownership for a year \n (use fulfilled by ridehailing)") +
  xlab("City") + ylab("Indifference Compensation (US$)") +
  theme_bw()


```


## During COVID (month)
### Data prep
```{r sbdc_covid_prep, warning = FALSE}
###SBDC1: Access to ride-hailing under typical conditions
SBDC1_CV.vars <- c("SBDC1_CV_1", "SBDC1_CV_2", "SBDC1_CV_3", "SBDC1_CV_4", "SBDC1_CV_5", "SBDC1_CV_6", 
                   "SBDC1_CV_7", "SBDC1_CV_8", "SBDC1_CV_9", "SBDC1_CV_10", "SBDC1_CV_11", "SBDC1_CV_12")
data_SBDC1_CV <- subset(data_gc, select=SBDC1_CV.vars)
data_SBDC1_CV[,] <-  ifelse(data_SBDC1_CV[,] ==
      'Keep access to ride-hailing services and receive no money', 0, 1)
data_SBDC1_CV$ResponseId <- data_gc$ResponseId

data_SBDC1_CV_long <- melt(data_SBDC1_CV, id.vars="ResponseId") #from wide to long format
data_SBDC1_CV_long <- data_SBDC1_CV_long[complete.cases(data_SBDC1_CV_long), ]
data_SBDC1_CV_long$variable <- recode(data_SBDC1_CV_long$variable, 
                              "'SBDC1_CV_1'=2; 'SBDC1_CV_2'=4; 'SBDC1_CV_3'=8; 'SBDC1_CV_4'=20;
                              'SBDC1_CV_5'=40; 'SBDC1_CV_6'=60; 'SBDC1_CV_7'=80; 'SBDC1_CV_8'=200; 
                              'SBDC1_CV_9'=425; 'SBDC1_CV_10'=650; 'SBDC1_CV_11'=800; 'SBDC1_CV_12'=1000")
colnames(data_SBDC1_CV_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC1_CV_long$Choice <- as.factor(data_SBDC1_CV_long$Choice) 
data_SBDC1_CV_long$Compensation <- as.numeric(as.character(data_SBDC1_CV_long$Compensation))
data_SBDC1_CV_long$Log_Comp <- log(data_SBDC1_CV_long$Compensation)
data_SBDC1_CV_long <- merge(data_SBDC1_CV_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC1_CV_long <- filter(data_SBDC1_CV_long, UsedRH==1)


### SBDC2: Access to private car under typical conditions
SBDC2_CV.vars <- c("SBDC2_CV_1", "SBDC2_CV_2", "SBDC2_CV_3", "SBDC2_CV_4", "SBDC2_CV_5", "SBDC2_CV_6", 
                   "SBDC2_CV_7", "SBDC2_CV_8", "SBDC2_CV_9", "SBDC2_CV_10", "SBDC2_CV_11", "SBDC2_CV_12", 
                   "SBDC2_CV_13", "SBDC2_CV_14", "SBDC2_CV_15")
data_SBDC2_CV <- subset(data_gc, select=SBDC2_CV.vars)
data_SBDC2_CV[,] <-  ifelse(data_SBDC2_CV[,] ==
      'Keep access to my primary vehicle and receive no money', 0, 1)
data_SBDC2_CV$ResponseId <- data_gc$ResponseId

data_SBDC2_CV_long <- melt(data_SBDC2_CV, id.vars="ResponseId") #from wide to long format
data_SBDC2_CV_long <- data_SBDC2_CV_long[complete.cases(data_SBDC2_CV_long), ]
data_SBDC2_CV_long$variable <- recode(data_SBDC2_CV_long$variable, 
                              "'SBDC2_CV_1'=10; 'SBDC2_CV_2'=40; 'SBDC2_CV_3'=80; 'SBDC2_CV_4'=150;
                              'SBDC2_CV_5'=250; 'SBDC2_CV_6'=300; 'SBDC2_CV_7'=400; 'SBDC2_CV_8'=625; 
                              'SBDC2_CV_9'=800; 'SBDC2_CV_10'=1250; 'SBDC2_CV_11'=1500; 'SBDC2_CV_12'=2000; 
                              'SBDC2_CV_13'=3000; 'SBDC2_CV_14'=4000; 'SBDC2_CV_15'=6250")
colnames(data_SBDC2_CV_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC2_CV_long$Choice <- as.factor(data_SBDC2_CV_long$Choice) 
data_SBDC2_CV_long$Compensation <- as.numeric(as.character(data_SBDC2_CV_long$Compensation))
data_SBDC2_CV_long$Log_Comp <- log(data_SBDC2_CV_long$Compensation)
data_SBDC2_CV_long <- merge(data_SBDC2_CV_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC2_CV_long <- filter(data_SBDC2_CV_long, CarOwner==1)


### SBDC3: Access to private car with free ride-hailing
SBDC3_CV.vars <- c("SBDC3_CV_1", "SBDC3_CV_2", "SBDC3_CV_3", "SBDC3_CV_4", "SBDC3_CV_5", "SBDC3_CV_6", 
                "SBDC3_CV_7", "SBDC3_CV_8", "SBDC3_CV_9", "SBDC3_CV_10", "SBDC3_CV_11", "SBDC3_CV_12", 
                "SBDC3_CV_13", "SBDC3_CV_14", "SBDC3_CV_15")
data_SBDC3_CV <- subset(data_gc, select=SBDC3_CV.vars)
data_SBDC3_CV[,] <-  ifelse(data_SBDC3_CV[,] ==
      'Keep access to my primary vehicle and receive no free ride-hailing nor money', 0, 1)
data_SBDC3_CV$ResponseId <- data_gc$ResponseId

data_SBDC3_CV_long <- melt(data_SBDC3_CV, id.vars="ResponseId") #from wide to long format
data_SBDC3_CV_long <- data_SBDC3_CV_long[complete.cases(data_SBDC3_CV_long), ]
data_SBDC3_CV_long$variable <- recode(data_SBDC3_CV_long$variable, 
                              "'SBDC3_CV_1'=10; 'SBDC3_CV_2'=40; 'SBDC3_CV_3'=80; 'SBDC3_CV_4'=150;
                              'SBDC3_CV_5'=250; 'SBDC3_CV_6'=300; 'SBDC3_CV_7'=400; 'SBDC3_CV_8'=625; 
                              'SBDC3_CV_9'=800; 'SBDC3_CV_10'=1250; 'SBDC3_CV_11'=1500; 'SBDC3_CV_12'=2000; 
                              'SBDC3_CV_13'=3000; 'SBDC3_CV_14'=4000; 'SBDC3_CV_15'=6250")
colnames(data_SBDC3_CV_long) <- c("ResponseId","Compensation", "Choice")
data_SBDC3_CV_long$Choice <- as.factor(data_SBDC3_CV_long$Choice) 
data_SBDC3_CV_long$Compensation <- as.numeric(as.character(data_SBDC3_CV_long$Compensation))
data_SBDC3_CV_long$Log_Comp <- log(data_SBDC3_CV_long$Compensation)
data_SBDC3_CV_long <- merge(data_SBDC3_CV_long, data_sociodem, by="ResponseId") #merge sociodemographics
data_SBDC3_CV_long <- filter(data_SBDC3_CV_long, CarOwner==1)
```

### Base panel model (intercept and compensation only)
```{r sbdc_covid_basemod, warning = FALSE}
#SBDC1.
logit_SBDC1.CV <- pglm(Choice ~ Log_Comp, 
                 data = data_SBDC1_CV_long, family = "binomial", 
                 effect="individual", model="random", index="ResponseId")
summary(logit_SBDC1.CV)
confint(logit_SBDC1.CV)

b0.1.CV <- logit_SBDC1.CV$estimate[1]
bC.1.CV <- logit_SBDC1.CV$estimate[2]
medianWTAC.1.CV <- exp(-b0.1.CV/bC.1.CV)
medianWTAC.1.CV

set.seed(111)
bres.1.CV <- matrix(NA,nrow=nboot,
                    ncol=length(coef(logit_SBDC1.CV)),
                    dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit_SBDC1.CV))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC1_CV_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC1_CV_long, ResponseId %in% rand.ids)
  bfit <- update(logit_SBDC1.CV, data=bdat)  
  bres.1.CV[i,] <- coef(bfit)
}

bres.1.CV <- data.frame(bres.1.CV)
colnames(bres.1.CV) <- c("b0.1.CV", "bC.1.CV", "sigma.1.CV")
bres.1.CV <- bres.1.CV %>% mutate(medianWTAC.1.CV = exp(-b0.1.CV/bC.1.CV))

confint.1.CV <- data.frame(mean_est=colMeans(bres.1.CV),
      t(apply(bres.1.CV, 2, quantile, c(0.025,0.975))))
confint.1.CV


#SBDC2.
logit_SBDC2.CV <- pglm(Choice ~ Log_Comp, 
                      data = data_SBDC2_CV_long, family = "binomial",
                      effect="individual", model="random", index="ResponseId")
summary(logit_SBDC2.CV)
confint(logit_SBDC2.CV)

b0.2.CV <- logit_SBDC2.CV$estimate[1]
bC.2.CV <- logit_SBDC2.CV$estimate[2]
medianWTAC.2.CV <- exp(-b0.2.CV/bC.2.CV)
medianWTAC.2.CV

set.seed(211)
bres.2.CV <- matrix(NA,nrow=nboot,
                    ncol=length(coef(logit_SBDC2.CV)),
                    dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit_SBDC2.CV))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC2_CV_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC2_CV_long, ResponseId %in% rand.ids)
  bfit <- update(logit_SBDC2.CV, data=bdat)  
  bres.2.CV[i,] <- coef(bfit)
}

bres.2.CV <- data.frame(bres.2.CV)
colnames(bres.2.CV) <- c("b0.2.CV", "bC.2.CV", "sigma.2.CV")
bres.2.CV <- bres.2.CV %>% mutate(medianWTAC.2.CV = exp(-b0.2.CV/bC.2.CV))

confint.2.CV <- data.frame(mean_est=colMeans(bres.2.CV),
      t(apply(bres.2.CV, 2, quantile, c(0.025,0.975))))
confint.2.CV


#SBDC3.
logit_SBDC3.CV <- pglm(Choice ~ Log_Comp, 
                      data = data_SBDC3_CV_long, CarOwner==1, family = "binomial",
                      effect="individual", model="random", index="ResponseId")
summary(logit_SBDC3.CV)
confint(logit_SBDC3.CV)

b0.3.CV <- logit_SBDC3.CV$estimate[1]
bC.3.CV <- logit_SBDC3.CV$estimate[2]
medianWTAC.3.CV <- exp(-b0.3.CV/bC.3.CV)
medianWTAC.3.CV

set.seed(311)
bres.3.CV <- matrix(NA,nrow=nboot,
                    ncol=length(coef(logit_SBDC3.CV)),
                    dimnames=list(rep=seq(nboot),
                                coef=names(coef(logit_SBDC3.CV))))

for (i in seq(nboot)) {
  rand.ids <- sample(unique(data_SBDC3_CV_long$ResponseId), size=bootsize, replace=TRUE)
  bdat <- subset(data_SBDC3_CV_long, ResponseId %in% rand.ids)
  bfit <- update(logit_SBDC3.CV, data=bdat)  
  bres.3.CV[i,] <- coef(bfit)
}

bres.3.CV <- data.frame(bres.3.CV)
colnames(bres.3.CV) <- c("b0.3.CV", "bC.3.CV", "sigma.3.CV")
bres.3.CV <- bres.3.CV %>% mutate(medianWTAC.3.CV = exp(-b0.3.CV/bC.3.CV))

confint.3.CV <- data.frame(mean_est=colMeans(bres.3.CV),
      t(apply(bres.3.CV, 2, quantile, c(0.025,0.975))))
confint.3.CV

```

