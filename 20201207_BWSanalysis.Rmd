---
title: "Car Valuation Survey - Best-Worst Scaling"
author: "Joanna Moody"
date: "Last updated: December 7, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Set up
## Initialize packages
```{r packages, warning = FALSE, message=FALSE}
library(ggplot2)
library(viridis)
library(grid)
library(gridExtra)
library(dplyr)
library(tidyverse)
library(reshape2) #melt function
library(mlogit)

library(support.BWS)
```

## Load data
```{r data, warning = FALSE}
#Read-in Qualtrics survey responses
data_raw <- read.csv("C:/Users/jcmoody/Dropbox (MIT)/MITei MaaS Adoption/Data/Qualtrics_FinalSample/Car+Ownership+Valuation+Survey+-+Revised_July+3%2C+2020_10.45.csv", stringsAsFactors=FALSE,na.strings=c("","NA"))
data_gc <- filter(data_raw, gc==1)

#Remove additional "header" rows from Qualtrics data export
data_gc <- data_gc[3:nrow(data_gc),] 
data_gc$ResponseId_orig <- data_gc$ResponseId
data_gc$ResponseId <- as.factor(1:nrow(data_gc))
```


# Best-Worst Scaling
Respondents are randomly allocated into one of two sets of BWS question: either pre-COVID or during COVID. The set of questions they received is indicated by the "BWS_Scenario" variable (either 1 or 2). We will need to clean these blocks separately.

Within each set, there are 10 BWS questions Q1 through Q10. Each question has three options _1 = Mobility Good, _2 = Other Good, and _3 = Earnings.

## Pre-COVID (year)
```{r bws_precovid, warning = FALSE}
data_BWS_Scen1 <- filter(data_gc, BWS_Scenario==1)

BWS.vars <-c("BWS_Q1_1", "BWS_Q1_2", "BWS_Q1_3", "BWS_Q2_1", "BWS_Q2_2", "BWS_Q2_3",
             "BWS_Q3_1", "BWS_Q3_2", "BWS_Q3_3", "BWS_Q4_1", "BWS_Q4_2", "BWS_Q4_3",
             "BWS_Q5_1", "BWS_Q5_2", "BWS_Q5_3", "BWS_Q6_1", "BWS_Q6_2", "BWS_Q6_3",
             "BWS_Q7_1", "BWS_Q7_2", "BWS_Q7_3", "BWS_Q8_1", "BWS_Q8_2", "BWS_Q8_3",
             "BWS_Q9_1", "BWS_Q9_2", "BWS_Q9_3", "BWS_Q10_1", "BWS_Q10_2", "BWS_Q10_3")

BWS.embeddata <- c("MobilityGood_Q1", "OtherGood_Q1", "Earnings_Q1",
                    "MobilityGood_Q2", "OtherGood_Q2", "Earnings_Q2",
                    "MobilityGood_Q3", "OtherGood_Q3", "Earnings_Q3",
                    "MobilityGood_Q4", "OtherGood_Q4", "Earnings_Q4",
                    "MobilityGood_Q5", "OtherGood_Q5", "Earnings_Q5",
                    "MobilityGood_Q6", "OtherGood_Q6", "Earnings_Q6",
                    "MobilityGood_Q7", "OtherGood_Q7", "Earnings_Q7",
                    "MobilityGood_Q8", "OtherGood_Q8", "Earnings_Q8",
                    "MobilityGood_Q9", "OtherGood_Q9", "Earnings_Q9",
                    "MobilityGood_Q10", "OtherGood_Q10", "Earnings_Q10")


###Step 1: 
#Recode BWS_Q1_CV_1 through BWS_Q10_CV_3 so that best option = 1 and worst option = -1
data_BWS_Scen1[, colnames(data_BWS_Scen1)%in%BWS.vars] <-  ifelse(data_BWS_Scen1[, colnames(data_BWS_Scen1)%in%BWS.vars]=="Best option", 1, ifelse(data_BWS_Scen1[, colnames(data_BWS_Scen1)%in%BWS.vars]=="Worst option", -1, 0))
#  also replace "NA" for the middle option with zero
data_BWS_Scen1[, colnames(data_BWS_Scen1)%in%BWS.vars] <- sapply(data_BWS_Scen1[, colnames(data_BWS_Scen1)%in%BWS.vars], function(x) replace_na(x,0))


###Step 2:                         
#Create dataframe in the format needed to use mlogit package to estimate MNL
#  Long-format with column headings = c("Id", "Q", "set", "choice", 25 options each as -1/0/1)
#  Using this example: https://docs.displayr.com/wiki/Analyzing_MaxDiff_Using_Standard_Logit_Models_Using_R
#  Alternative example: http://lab.agr.hokudai.ac.jp/nmvr/03-bws1.html

data_BWS_Q1 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q1_1", "BWS_Q1_2", "BWS_Q1_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q1 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q1", "OtherGood_Q1", "Earnings_Q1")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q1) <- c("ResponseId", "variable", "option")
data_BWS_Q1 <- cbind(data_BWS_Q1, subset(embeddata_BWS_Q1, select=c("option")))
data_BWS_Q1$Q <- 1
data_BWS_Q1_best <- dplyr::mutate(data_BWS_Q1, choice = ifelse(value==1, 1, 0))
data_BWS_Q1_best$set <- 1
data_BWS_Q1_worst <- dplyr::mutate(data_BWS_Q1, choice = ifelse(value==-1, 1, 0))
data_BWS_Q1_worst$set <- 2


data_BWS_Q2 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q2_1", "BWS_Q2_2", "BWS_Q2_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q2 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q2", "OtherGood_Q2", "Earnings_Q2")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q2) <- c("ResponseId", "variable", "option")
data_BWS_Q2 <- cbind(data_BWS_Q2, subset(embeddata_BWS_Q2, select=c("option")))
data_BWS_Q2$Q <- 2
data_BWS_Q2_best <- dplyr::mutate(data_BWS_Q2, choice = ifelse(value==1, 1, 0))
data_BWS_Q2_best$set <- 3
data_BWS_Q2_worst <- dplyr::mutate(data_BWS_Q2, choice = ifelse(value==-1, 1, 0))
data_BWS_Q2_worst$set <- 4


data_BWS_Q3 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q3_1", "BWS_Q3_2", "BWS_Q3_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q3 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q3", "OtherGood_Q3", "Earnings_Q3")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q3) <- c("ResponseId", "variable", "option")
data_BWS_Q3 <- cbind(data_BWS_Q3, subset(embeddata_BWS_Q3, select=c("option")))
data_BWS_Q3$Q <- 3
data_BWS_Q3_best <- dplyr::mutate(data_BWS_Q3, choice = ifelse(value==1, 1, 0))
data_BWS_Q3_best$set <- 5
data_BWS_Q3_worst <- dplyr::mutate(data_BWS_Q3, choice = ifelse(value==-1, 1, 0))
data_BWS_Q3_worst$set <- 6


data_BWS_Q4 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q4_1", "BWS_Q4_2", "BWS_Q4_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q4 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q4", "OtherGood_Q4", "Earnings_Q4")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q4) <- c("ResponseId", "variable", "option")
data_BWS_Q4 <- cbind(data_BWS_Q4, subset(embeddata_BWS_Q4, select=c("option")))
data_BWS_Q4$Q <- 4
data_BWS_Q4_best <- dplyr::mutate(data_BWS_Q4, choice = ifelse(value==1, 1, 0))
data_BWS_Q4_best$set <- 7
data_BWS_Q4_worst <- dplyr::mutate(data_BWS_Q4, choice = ifelse(value==-1, 1, 0))
data_BWS_Q4_worst$set <- 8


data_BWS_Q5 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q5_1", "BWS_Q5_2", "BWS_Q5_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q5 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q5", "OtherGood_Q5", "Earnings_Q5")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q5) <- c("ResponseId", "variable", "option")
data_BWS_Q5 <- cbind(data_BWS_Q5, subset(embeddata_BWS_Q5, select=c("option")))
data_BWS_Q5$Q <- 5
data_BWS_Q5_best <- dplyr::mutate(data_BWS_Q5, choice = ifelse(value==1, 1, 0))
data_BWS_Q5_best$set <- 9
data_BWS_Q5_worst <- dplyr::mutate(data_BWS_Q5, choice = ifelse(value==-1, 1, 0))
data_BWS_Q5_worst$set <- 10


data_BWS_Q6 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q6_1", "BWS_Q6_2", "BWS_Q6_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q6 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q6", "OtherGood_Q6", "Earnings_Q6")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q6) <- c("ResponseId", "variable", "option")
data_BWS_Q6 <- cbind(data_BWS_Q6, subset(embeddata_BWS_Q6, select=c("option")))
data_BWS_Q6$Q <- 6
data_BWS_Q6_best <- dplyr::mutate(data_BWS_Q6, choice = ifelse(value==1, 1, 0))
data_BWS_Q6_best$set <- 11
data_BWS_Q6_worst <- dplyr::mutate(data_BWS_Q6, choice = ifelse(value==-1, 1, 0))
data_BWS_Q6_worst$set <- 12


data_BWS_Q7 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q7_1", "BWS_Q7_2", "BWS_Q7_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q7 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q7", "OtherGood_Q7", "Earnings_Q7")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q7) <- c("ResponseId", "variable", "option")
data_BWS_Q7 <- cbind(data_BWS_Q7, subset(embeddata_BWS_Q7, select=c("option")))
data_BWS_Q7$Q <- 7
data_BWS_Q7_best <- dplyr::mutate(data_BWS_Q7, choice = ifelse(value==1, 1, 0))
data_BWS_Q7_best$set <- 13
data_BWS_Q7_worst <- dplyr::mutate(data_BWS_Q7, choice = ifelse(value==-1, 1, 0))
data_BWS_Q7_worst$set <- 14


data_BWS_Q8 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q8_1", "BWS_Q8_2", "BWS_Q8_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q8 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q8", "OtherGood_Q8", "Earnings_Q8")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q8) <- c("ResponseId", "variable", "option")
data_BWS_Q8 <- cbind(data_BWS_Q8, subset(embeddata_BWS_Q8, select=c("option")))
data_BWS_Q8$Q <- 8
data_BWS_Q8_best <- dplyr::mutate(data_BWS_Q8, choice = ifelse(value==1, 1, 0))
data_BWS_Q8_best$set <- 15
data_BWS_Q8_worst <- dplyr::mutate(data_BWS_Q8, choice = ifelse(value==-1, 1, 0))
data_BWS_Q8_worst$set <- 16


data_BWS_Q9 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q9_1", "BWS_Q9_2", "BWS_Q9_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q9 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q9", "OtherGood_Q9", "Earnings_Q9")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q9) <- c("ResponseId", "variable", "option")
data_BWS_Q9 <- cbind(data_BWS_Q9, subset(embeddata_BWS_Q9, select=c("option")))
data_BWS_Q9$Q <- 9
data_BWS_Q9_best <- dplyr::mutate(data_BWS_Q9, choice = ifelse(value==1, 1, 0))
data_BWS_Q9_best$set <- 17
data_BWS_Q9_worst <- dplyr::mutate(data_BWS_Q9, choice = ifelse(value==-1, 1, 0))
data_BWS_Q9_worst$set <- 18


data_BWS_Q10 <- melt(data_BWS_Scen1[,c("ResponseId", "BWS_Q10_1", "BWS_Q10_2", "BWS_Q10_3")], id.vars=c("ResponseId"))
embeddata_BWS_Q10 <- melt(data_BWS_Scen1[,c("ResponseId", "MobilityGood_Q10", "OtherGood_Q10", "Earnings_Q10")], id.vars=c("ResponseId"))
colnames(embeddata_BWS_Q10) <- c("ResponseId", "variable", "option")
data_BWS_Q10 <- cbind(data_BWS_Q10, subset(embeddata_BWS_Q10, select=c("option")))
data_BWS_Q10$Q <- 10
data_BWS_Q10_best <- dplyr::mutate(data_BWS_Q10, choice = ifelse(value==1, 1, 0))
data_BWS_Q10_best$set <- 19
data_BWS_Q10_worst <- dplyr::mutate(data_BWS_Q10, choice = ifelse(value==-1, 1, 0))
data_BWS_Q10_worst$set <- 20



data_best <- rbind(subset(data_BWS_Q1_best, select=c("ResponseId", "Q", "set", "option", "choice")), 
                   subset(data_BWS_Q2_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q3_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q4_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q5_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q6_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q7_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q8_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q9_best, select=c("ResponseId", "Q", "set", "option", "choice")),
                   subset(data_BWS_Q10_best, select=c("ResponseId", "Q", "set", "option", "choice")))

data_worst <- rbind(subset(data_BWS_Q1_worst, select=c("ResponseId", "Q", "set", "option", "choice")), 
                    subset(data_BWS_Q2_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q3_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q4_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q5_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q6_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q7_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q8_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q9_worst, select=c("ResponseId", "Q", "set", "option", "choice")),
                    subset(data_BWS_Q10_worst, select=c("ResponseId", "Q", "set", "option", "choice")))

data_best <-  dplyr::mutate(data_best, 
                               Mob1 = ifelse(option=="No access to personal car", 1, 0),
                               Mob2 = ifelse(option=="No access to airline travel", 1, 0),
                               Mob3 = ifelse(option=="No access to exclusive ride-hailing services (e.g., UberX or Lyft Classic)", 1, 0),
                               Mob4 = ifelse(option=="No access to train", 1, 0),
                               Mob5 = ifelse(option=="No access to car rental or car sharing (e.g., Zipcar)", 1, 0),
                               Mob6 = ifelse(option=="No access to personal bike", 1, 0),
                               Mob7 = ifelse(option=="No access to bus" , 1, 0),
                               Mob8 = ifelse(option=="No access to pooled ride-hailing services (e.g., UberPOOL or Lyft Shared)", 1, 0),
                               Mob9 = ifelse(option=="No access to bike or scooter share", 1, 0),
                               Other1 = ifelse(option=="No access to online maps", 1, 0),
                               Other2 = ifelse(option=="No access to a personal computer or laptop", 1, 0),
                               Other3 = ifelse(option=="No access to a smart phone", 1, 0),
                               Other4 = ifelse(option=="No toilets in the home", 1, 0),
                               Other5 = ifelse(option=="No access to all e-mail services", 1, 0),
                               Other6 = ifelse(option=="No TVs in the home", 1, 0),
                               Other7 = ifelse(option=="No meeting with friends in person", 1, 0),
                               Earn1 = ifelse(option=="Earning $100 less", 1, 0),
                               Earn2 = ifelse(option=="Earning $200 less", 1, 0),
                               Earn3 = ifelse(option=="Earning $500 less", 1, 0),
                               Earn4 = ifelse(option=="Earning $1,000 less", 1, 0),
                               Earn5 = ifelse(option=="Earning $2,000 less", 1, 0),
                               Earn6 = ifelse(option=="Earning $5,000 less", 1, 0),
                               Earn7 = ifelse(option=="Earning $10,000 less", 1, 0),
                               Earn8 = ifelse(option=="Earning $15,000 less", 1, 0),
                               Earn9 = ifelse(option=="Earning $20,000 less", 1, 0))

data_worst <-  dplyr::mutate(data_worst, 
                               Mob1 = ifelse(option=="No access to personal car", -1, 0),
                               Mob2 = ifelse(option=="No access to airline travel", -1, 0),
                               Mob3 = ifelse(option=="No access to exclusive ride-hailing services (e.g., UberX or Lyft Classic)", -1, 0),
                               Mob4 = ifelse(option=="No access to train", -1, 0),
                               Mob5 = ifelse(option=="No access to car rental or car sharing (e.g., Zipcar)", -1, 0),
                               Mob6 = ifelse(option=="No access to personal bike", -1, 0),
                               Mob7 = ifelse(option=="No access to bus", -1, 0),
                               Mob8 = ifelse(option=="No access to pooled ride-hailing services (e.g., UberPOOL or Lyft Shared)", -1, 0),
                               Mob9 = ifelse(option=="No access to bike or scooter share", -1, 0),
                               Other1 = ifelse(option=="No access to online maps", -1, 0),
                               Other2 = ifelse(option=="No access to a personal computer or laptop", -1, 0),
                               Other3 = ifelse(option=="No access to a smart phone", -1, 0),
                               Other4 = ifelse(option=="No toilets in the home", -1, 0),
                               Other5 = ifelse(option=="No access to all e-mail services", -1, 0),
                               Other6 = ifelse(option=="No TVs in the home", -1, 0),
                               Other7 = ifelse(option=="No meeting with friends in person", -1, 0),
                               Earn1 = ifelse(option=="Earning $100 less", -1, 0),
                               Earn2 = ifelse(option=="Earning $200 less", -1, 0),
                               Earn3 = ifelse(option=="Earning $500 less", -1, 0),
                               Earn4 = ifelse(option=="Earning $1,000 less", -1, 0),
                               Earn5 = ifelse(option=="Earning $2,000 less", -1, 0),
                               Earn6 = ifelse(option=="Earning $5,000 less", -1, 0),
                               Earn7 = ifelse(option=="Earning $10,000 less", -1, 0),
                               Earn8 = ifelse(option=="Earning $15,000 less", -1, 0),
                               Earn9 = ifelse(option=="Earning $20,000 less", -1, 0))


data_bestworst <- rbind(data_best, data_worst)
data_bestworst <- data_bestworst %>% arrange(ResponseId, Q, set)
data_bestworst$choiceid <- paste0(data_bestworst$ResponseId, "_", data_bestworst$set)
data_bws_mldat <- mlogit.data(data_bestworst, choice="choice", shape="long", alt.var="option", chid.var="choiceid", id.var="ResponseId", drop.index=FALSE)



###Descriptive Statistics
option <- c("No access to personal car", "No access to airline travel",
                      "No access to exclusive ride-hailing services (e.g., UberX or Lyft Classic)", 
                      "No access to train", "No access to car rental or car sharing (e.g., Zipcar)",
                      "No access to personal bike","No access to buses",
                      "No access to pooled ride-hailing services (e.g., UberPOOL or Lyft Shared)",
                      "No access to bike or scooter share", "No access to online maps",
                      "No access to a personal computer or laptop", "No access to a smart phone",
                      "No toilets in the home", "No access to all e-mail services", "No TVs in the home",
                      "No meeting with friends in person", "Earning $100 less",
                      "Earning $200 less", "Earning $500 less", "Earning $1,000 less", 
                      "Earning $2,000 less", "Earning $5,000 less", "Earning $10,000 less", 
                      "Earning $15,000 less", "Earning $20,000 less")

#Calculate the total number of times that each object of interest is chosen as best and worst across all choice sets and individuals
#Count total number of appearances of each option
data_bws.tab <- data.frame(sapply(data_bestworst[,6:30], table))
data_bws.tab <- data.frame(t(data_bws.tab))

#Count number of best and worst choices of each option
data_bws.tab2 <- data.frame(sapply(data_bestworst[,6:30], function(x) x*data_bestworst$choice))
data_bws.tab2 <- data.frame(sapply(data_bws.tab2, table))
data_bws.tab2 <- data.frame(t(data_bws.tab2))
colnames(data_bws.tab2) <- c("Count_W", "Count_mid", "Count_B")
data_bws.tab2$option <- option

data_bws.tab2$Count_total <- data_bws.tab$X1
data_bws.tab2 <- data_bws.tab2 %>% mutate(Prop_W = Count_W / Count_total,
                                          Prop_B = Count_B / Count_total,
                                          BminusW = Count_B - Count_W)

data_bws.tab2


option.no100 <- c("No access to personal car", "No access to airline travel",
                      "No access to exclusive ride-hailing services", 
                      "No access to train", "No access to car rental or car sharing",
                      "No access to personal bike","No access to buses",
                      "No access to pooled ride-hailing services",
                      "No access to bike or scooter share", "No access to online maps",
                      "No access to a personal computer or laptop", "No access to a smart phone",
                      "No toilets in the home", "No access to all e-mail services", "No TVs in the home",
                      "No meeting with friends in person", 
                      "Earning $200 less", "Earning $500 less", "Earning $1,000 less", 
                      "Earning $2,000 less", "Earning $5,000 less", "Earning $10,000 less", 
                      "Earning $15,000 less", "Earning $20,000 less")

#Run the MNL with only alternative-specific constants using lowest earnings (Earn1 = $100) as the reference
# We expect that there will be a greater utility of giving up each item (negative ASC) compared to giving up $100
rank <- mlogit::mlogit(choice ~ Mob1 + Mob2 + Mob3 + Mob4 + Mob5 +
                Mob6 + Mob7 + Mob8 + Mob9 +
                Other1 + Other2 + Other3 + Other4 +
                Other5 + Other6 + Other7 + #Earn1 +
                Earn2 + Earn3 + Earn4 + Earn5 + 
                Earn6 + Earn7 + Earn8 + Earn9 - 1, #-1 means no alternative specific constants
        data = data_bws_mldat)
#The most straightforward interpretation of these values is that they indicate the rank ordering of the preferences 
summary(rank)

disutility <- coef(summary(rank))[,1]
std_err <- coef(summary(rank))[,2]
disutility <- unname(disutility)
std_err <- unname(std_err)
rank_estimates <- data.frame(cbind(option.no100, disutility, std_err))
rank_estimates$disutility <- as.numeric(as.character(rank_estimates$disutility))
rank_estimates$std_err <- as.numeric(as.character(rank_estimates$std_err))
rank_estimates <- rank_estimates %>% mutate(option.no100 = fct_reorder(option.no100, desc(disutility)))

rank_estimates

ggplot(data=rank_estimates)+
  geom_col(aes(x=option.no100,y=disutility), fill="grey")+
  scale_x_discrete(position="top", expand=c(0,0)) +
  geom_errorbar(aes(x=option.no100,ymin=disutility-std_err, ymax=disutility+std_err), width=.2,
                position=position_dodge(.9))+
  theme_bw()+
  xlab("") +
  coord_flip()

ggsave(filename="BWS_pre-COVID.jpg", plot=last_plot(), height=5, width=8, units="in", dpi=800)


#Introducing panel effects with a mixture model can theoretically be done using mlogit package
#  https://cran.r-project.org/web/packages/mlogit/vignettes/c5.mxl.html
#  However, there is no "intercept" term and model is too complex to estimate a random coefficient for each of the 24 options -- fails to converge

```


